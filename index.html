<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>íŒŒí¬ê³¨í”„ í”„ë¡œ v5.5 (Final Edition)</title>
    <style>
        /* --- ì†Œê°œ í™”ë©´ ìŠ¤íƒ€ì¼ --- */
        #intro-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(160deg, #1b5e20 0%, #0a3d12 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20000; text-align: center; color: white; transition: opacity 0.6s ease;
            padding: 20px; box-sizing: border-box;
        }
        .intro-visual { font-size: 80px; margin-bottom: 10px; animation: float 3s infinite ease-in-out; }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .intro-title { font-size: 36px; font-weight: 900; color: #d4af37; margin: 0 0 10px 0; }
        .intro-msg { font-size: 18px; margin-bottom: 40px; line-height: 1.5; opacity: 0.9; }
        .btn-start { 
            width: 85%; max-width: 260px; padding: 18px 0; border-radius: 50px; border: none;
            background: linear-gradient(45deg, #d4af37, #f9e29d, #d4af37);
            background-size: 200% auto; color: #1b5e20; font-size: 22px; font-weight: 900; 
            cursor: pointer; box-shadow: 0 10px 25px rgba(0,0,0,0.4);
            animation: pulse 2s infinite, shine 3s infinite linear;
        }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes shine { to { background-position: 200% center; } }
        .intro-footer { position: absolute; bottom: 30px; font-size: 12px; opacity: 0.6; }

        /* --- ìŠ¤íƒ€ì¼ --- */
        :root {
            --primary: #2e7d32; --bg: #f4f7f6; --played-all: #ffd600; 
            --played-part: #f8bbd0; --not-played: #ffffff; --danger: #d32f2f;
            --accent: #1976d2; --win-color: #fb8c00; --draw-color: #78909c; --fail-color: #8d6e63;
        }
        body { font-family: 'Pretendard', -apple-system, sans-serif; margin: 0; background: var(--bg); color: #212121; -webkit-tap-highlight-color: transparent; }
        header { background: var(--primary); color: white; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        nav { display: flex; justify-content: space-around; }
        nav button { background: none; border: none; color: rgba(255,255,255,0.7); padding: 15px; font-weight: bold; font-size: 16px; cursor: pointer; flex: 1; }
        nav button.active { color: white; border-bottom: 4px solid var(--played-all); }
        .container { padding: 15px; max-width: 480px; margin: 0 auto; }
        .card { background: white; border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.06); }
        .course-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .course-btn { padding: 15px 5px; border: 1.5px solid #ddd; border-radius: 15px; font-weight: bold; font-size: 15px; transition: 0.2s; height: 75px; cursor: pointer; }
        .course-btn.status-all { background: var(--played-all); border-color: #fbc02d; }
        .course-btn.status-part { background: var(--played-part); border-color: #f06292; }
        .course-btn.status-none { background: var(--not-played); }
        .hole-indicator { display: grid; grid-template-columns: repeat(9, 1fr); gap: 5px; margin-bottom: 15px; }
        .hole-dot { aspect-ratio: 1/1; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: bold; background: #eee; border: 1.5px solid #ddd; cursor: pointer; }
        .hole-dot.active { border-color: var(--primary); background: white; color: var(--primary); box-shadow: 0 0 8px rgba(46,125,50,0.3); }
        .hole-dot.played { background: var(--played-all); border-color: #fbc02d; }
        .btn-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
        .btn-big { height: 55px; border: none; border-radius: 12px; font-size: 17px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-nav { background: #e8f5e9; color: var(--primary); border: 1px solid #c8e6c9; }
        .btn-result { background: #546e7a; color: white; }
        .btn-save { background: var(--accent); color: white; }
        .btn-next-course { background: #455a64; color: white; width: 100%; margin-top: 10px; height: 60px; }
        .player-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .p-btn { padding: 12px; border: 1.5px solid #eee; background: #fafafa; border-radius: 15px; font-size: 15px; font-weight: 600; cursor: pointer; }
        .p-btn.selected { background: var(--played-all); border-color: #fbc02d; font-weight: 800; transform: scale(1.02); }
        .badge-group { display: flex; gap: 5px; margin-top: 8px; flex-wrap: wrap; }
        .g-badge { padding: 4px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; display: flex; align-items: center; gap: 4px; }
        .g-win { background: #fff3e0; color: var(--win-color); border: 1px solid #ffe0b2; }
        .g-draw { background: #eceff1; color: var(--draw-color); border: 1px solid #cfd8dc; }
        .g-fail { background: #efebe9; color: var(--fail-color); border: 1px solid #d7ccc8; }
        .penalty-highlight { background: #fff5f5; border: 2.5px solid var(--danger); color: var(--danger); padding: 10px; border-radius: 15px; text-align: center; min-width: 90px; }
        .penalty-val { font-size: 15px; font-weight: 900; display: block; } /* í°íŠ¸ì‚¬ì´ì¦ˆ ì¡°ì • */
        .hidden { display: none !important; }
        #exit-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--primary); color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10000; text-align: center; }
    </style>
</head>
<body>

<div id="intro-screen">
    <div class="intro-content">
        <div class="intro-visual">ğŸ¦…</div>
        <h1 class="intro-title">ë…ìˆ˜ë¦¬ íŒŒí¬ê³¨í”„</h1>
        <p class="intro-msg">ë°˜ê°‘ìŠµë‹ˆë‹¤!<br><strong>ìµœê³ ì˜ ë¼ìš´ë”© íŒŒíŠ¸ë„ˆ</strong></p>
        <button class="btn-start" onclick="startApp()">í”„ë¡œê·¸ë¨ ì‹œì‘</button>
    </div>
    <div class="intro-footer">Version 6.3 Final | Created by <strong>ì˜¤ì¬í›ˆ</strong></div>
</div>

<div id="app-main" class="hidden">
    <header id="app-header">
        <nav>
            <button onclick="showScreen('player')" id="nav-player">í”Œë ˆì´ì–´</button>
            <button onclick="showScreen('game-setup')" id="nav-game">ì½”ìŠ¤ì„ íƒ</button>
            <button onclick="showScreen('records')" id="nav-records">ê¸°ë¡</button>
            <button onclick="exitApp()">ì¢…ë£Œ</button>
        </nav>
    </header>

    <div class="container" id="app-body">
        <section id="screen-player" class="screen"><h3 style="margin: 0 0 15px 5px;">í”Œë ˆì´ì–´ ë“±ë¡</h3><div id="player-inputs"></div></section>
        <section id="screen-game-setup" class="screen hidden">
            <div class="card"><label style="font-weight: bold;">í™€ë‹¹ ë²Œê¸ˆì•¡</label>
            <div style="margin-top:10px; display: flex; align-items: center; gap: 10px;"><input type="number" id="penalty-input" style="flex:1; padding:12px; border:2px solid var(--primary); border-radius:10px; font-size:18px; font-weight:bold; text-align: right;"><span style="font-weight:bold;">ì›</span></div></div>
            <div class="course-grid" id="course-btns"></div>
        </section>
        <section id="screen-game-play" class="screen hidden">
            <div class="hole-indicator" id="hole-indicator"></div><h2 id="display-hole-title" style="margin-top:0; color: var(--primary);">1ì½”ìŠ¤ - 1í™€</h2>
            <div class="btn-row"><button onclick="changeHole(-1)" class="btn-big btn-nav">â—€ ì´ì „í™€</button><button onclick="changeHole(1)" class="btn-big btn-nav">ë‹¤ìŒí™€ â–¶</button></div>
            <div class="card"><div id="play-player-btns" class="player-grid"></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; padding-top: 15px; border-top: 1px dashed #ddd;"><button class="p-btn" id="spec-draw" onclick="toggleSpecial('draw')">ğŸ¤ ë¬´ìŠ¹ë¶€</button><button class="p-btn" id="spec-fail" onclick="toggleSpecial('fail')">ğŸ’€ ëª¨ë‘ì‹¤íŒ¨</button></div></div>
            <div class="btn-row"><button onclick="showResult()" class="btn-big btn-result">ğŸ“Š ì½”ìŠ¤ê²°ê³¼</button><button onclick="saveCurrentGame(true)" class="btn-big btn-save">ğŸ’¾ í˜„ì¬ì €ì¥</button></div>
            <button onclick="nextCourseAction()" class="btn-big btn-next-course">â›³ ì½”ìŠ¤ ì™„ë£Œ í›„ ëª©ë¡ìœ¼ë¡œ</button>
        </section>
        <section id="screen-result" class="screen hidden"><div id="result-list"></div><button onclick="showScreen('game-play')" class="btn-big btn-save" style="width:100%; margin-top:10px;">ê²Œì„ í™”ë©´ìœ¼ë¡œ</button></section>
        <section id="screen-records" class="screen hidden"><div id="history-container"></div></section>
    </div>

    <div id="exit-overlay" class="hidden">
        <h1 style="font-size: 60px; margin-bottom: 20px;">â›³</h1><h2>ë°ì´í„° ì €ì¥ ì™„ë£Œ</h2>
        <p style="font-size: 18px; line-height: 1.6; opacity: 0.9;">í”„ë¡œê·¸ë¨ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.<br>ë¸Œë¼ìš°ì € íƒ­ì„ ì§ì ‘ ë‹«ì•„ì£¼ì„¸ìš”.</p>
        <button onclick="restartApp()" style="margin-top:40px; padding:15px 35px; border-radius:15px; border:none; font-weight:bold; background:white; color:var(--primary); font-size:18px; cursor:pointer;">ìƒˆ ê²Œì„ ì‹œì‘í•˜ê¸°</button>
    </div>
</div>

<script>
    let audioCtx = null;
    function playFeedback() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain); gain.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        if (navigator.vibrate) navigator.vibrate(50);
    }

    function attachFeedback() {
        document.querySelectorAll('button, .hole-dot').forEach(el => {
            if(!el.dataset.fb) { el.addEventListener('click', playFeedback); el.dataset.fb = "true"; }
        });
    }

    function startApp() {
        playFeedback();
        document.getElementById('intro-screen').style.opacity = '0';
        setTimeout(() => {
            document.getElementById('intro-screen').classList.add('hidden');
            document.getElementById('app-main').classList.remove('hidden');
            init();
        }, 600);
    }

    let state = { players: ["í”Œë ˆì´ì–´1", "í”Œë ˆì´ì–´2", "í”Œë ˆì´ì–´3", "í”Œë ˆì´ì–´4", "", ""], selectedIdx: [0, 1, 2, 3], penalty: 500, currentCourse: 1, currentHole: 1, courseData: {} };

    function init() {
        document.getElementById('exit-overlay').classList.add('hidden');
        document.getElementById('app-header').classList.remove('hidden');
        document.getElementById('app-body').classList.remove('hidden');
        const saved = localStorage.getItem('parkGolf_v5_5');
        if(saved) { try { state = Object.assign(state, JSON.parse(saved)); } catch(e) {} }
        document.getElementById('penalty-input').value = state.penalty || 500;
        renderPlayerSetup();
        showScreen('player');
    }

    function saveState() { state.penalty = parseInt(document.getElementById('penalty-input').value) || 500; localStorage.setItem('parkGolf_v5_5', JSON.stringify(state)); }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('screen-' + id).classList.remove('hidden');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        const navBtn = document.getElementById('nav-' + id.split('-')[0]);
        if(navBtn) navBtn.classList.add('active');
        if(id === 'game-setup') renderCourseBtns();
        if(id === 'records') renderHistory();
        window.scrollTo(0,0); attachFeedback();
    }

    function renderPlayerSetup() {
        const container = document.getElementById('player-inputs'); container.innerHTML = '';
        state.players.forEach((name, i) => {
            const div = document.createElement('div'); div.className = 'card'; div.style = "display:flex; gap:15px; align-items:center; padding:15px; margin-bottom:10px;";
            div.innerHTML = `<input type="text" value="${name}" onchange="state.players[${i}]=this.value; saveState();" placeholder="ì´ë¦„ ì…ë ¥" style="flex:1; padding:12px; border:1px solid #ddd; border-radius:10px; font-size:16px;"><input type="checkbox" style="width:25px; height:25px;" ${state.selectedIdx.includes(i) ? 'checked' : ''} onchange="togglePlayer(${i})">`;
            container.appendChild(div);
        });
        attachFeedback();
    }

    function togglePlayer(i) { if(state.selectedIdx.includes(i)) state.selectedIdx = state.selectedIdx.filter(idx => idx !== i); else state.selectedIdx.push(i); saveState(); }

    function renderCourseBtns() {
        const container = document.getElementById('course-btns'); container.innerHTML = '';
        for(let i=1; i<=12; i++) {
            const btn = document.createElement('button'); const data = state.courseData[i]; let status = 'status-none';
            if(data) { const playedCount = data.filter(h => h && (h.winners?.length > 0 || h.draw || h.fail)).length; if(playedCount >= 9) status = 'status-all'; else if(playedCount > 0) status = 'status-part'; }
            btn.className = `course-btn ${status}`; btn.innerHTML = `${i}ì½”ìŠ¤<br><small>${status==='status-all'?'ì™„ë£Œ':(status==='status-part'?'ì§„í–‰ì¤‘':'ë¯¸ì§„í–‰')}</small>`;
            btn.onclick = () => startCourse(i); container.appendChild(btn);
        }
        attachFeedback();
    }

    function startCourse(cIdx) {
        state.currentCourse = cIdx; state.currentHole = 1;
        if(!state.courseData[cIdx]) state.courseData[cIdx] = Array(10).fill(null).map(() => ({ winners: [], draw: false, fail: false }));
        showScreen('game-play'); updatePlayUI();
    }

    function updatePlayUI() {
        const cIdx = state.currentCourse; const hIdx = state.currentHole; const data = state.courseData[cIdx][hIdx];
        document.getElementById('display-hole-title').innerText = `${cIdx}ì½”ìŠ¤ - ${hIdx}í™€`;
        const indicator = document.getElementById('hole-indicator'); indicator.innerHTML = '';
        for(let i=1; i<=9; i++) {
            const dot = document.createElement('div'); const hData = state.courseData[cIdx][i];
            dot.className = `hole-dot ${i === hIdx ? 'active' : ''} ${hData && (hData.winners?.length > 0 || hData.draw || hData.fail) ? 'played' : ''}`;
            dot.innerText = i; dot.onclick = () => { state.currentHole = i; updatePlayUI(); }; indicator.appendChild(dot);
        }
        const pContainer = document.getElementById('play-player-btns'); pContainer.innerHTML = '';
        state.selectedIdx.forEach(idx => {
            const btn = document.createElement('button'); btn.className = `p-btn ${data.winners.includes(idx) ? 'selected' : ''}`;
            btn.innerText = state.players[idx] || `ì„ ìˆ˜${idx+1}`; btn.onclick = () => toggleWinner(idx); pContainer.appendChild(btn);
        });
        document.getElementById('spec-draw').className = `p-btn ${data.draw ? 'selected' : ''}`;
        document.getElementById('spec-fail').className = `p-btn ${data.fail ? 'selected' : ''}`;
        saveState(); attachFeedback();
    }

    function toggleWinner(idx) {
        const data = state.courseData[state.currentCourse][state.currentHole]; data.draw = false; data.fail = false;
        if(data.winners.includes(idx)) data.winners = data.winners.filter(v => v !== idx); else data.winners.push(idx); updatePlayUI();
    }

    function toggleSpecial(type) {
        const data = state.courseData[state.currentCourse][state.currentHole]; data.winners = [];
        if(type === 'draw') { data.draw = !data.draw; data.fail = false; } else { data.fail = !data.fail; data.draw = false; } updatePlayUI();
    }

    function changeHole(dir) { let next = state.currentHole + dir; if(next >= 1 && next <= 9) { state.currentHole = next; updatePlayUI(); } }

    function getSummary(cData, penalty, selPlayers) {
        let stats = {}; selPlayers.forEach(i => stats[i] = { win:0, draw:0, fail:0, pCount:0 }); if(!cData) return stats;
        Object.values(cData).forEach(hole => {
            if(!hole || (hole.winners.length === 0 && !hole.draw && !hole.fail)) return;
            if(hole.draw) selPlayers.forEach(idx => stats[idx].draw++);
            else if(hole.fail) selPlayers.forEach(idx => { stats[idx].fail++; stats[idx].pCount++; });
            else { selPlayers.forEach(idx => { if(hole.winners.includes(idx)) stats[idx].win++; else stats[idx].pCount++; }); }
        });
        return stats;
    }

    function showResult() {
        const stats = getSummary(state.courseData[state.currentCourse], state.penalty, state.selectedIdx);
        let totalP = 0;
        state.selectedIdx.forEach(idx => { totalP += stats[idx].pCount; });

        const container = document.getElementById('result-list'); 
        // [ìˆ˜ì •] ì œëª©ì— (ì´ ?íšŒ) ì¶”ê°€
        container.innerHTML = `<h3>${state.currentCourse}ì½”ìŠ¤ ì •ì‚° ê²°ê³¼ (ì´ ${totalP}íšŒ)</h3>`;
        
        state.selectedIdx.forEach(idx => { 
            const s = stats[idx]; 
            container.innerHTML += `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <div style="font-weight:bold; font-size:18px;">${state.players[idx]}</div>
                        <div class="badge-group">
                            <span class="g-badge g-win">ğŸ† ${s.win}</span>
                            <span class="g-badge g-draw">ğŸ¤ ${s.draw}</span>
                            <span class="g-badge g-fail">ğŸ’€ ${s.fail}</span>
                        </div>
                    </div>
                    <div class="penalty-highlight">
                        <span class="penalty-val">ë²Œê¸ˆ ${s.pCount}íšŒ</span>
                        <strong>${(s.pCount * state.penalty).toLocaleString()}ì›</strong>
                    </div>
                </div>`; 
        });
        showScreen('result'); attachFeedback();
    }

    function saveCurrentGame(isManual) {
        const today = new Date().toLocaleDateString(); let history = JSON.parse(localStorage.getItem('parkGolf_history_v5_5')) || [];
        let dayRec = history.find(h => h.date === today);
        if(!dayRec) { dayRec = { date: today, courses: {}, penalty: state.penalty, players: [...state.players], selected: [...state.selectedIdx] }; history.push(dayRec); }
        dayRec.courses[state.currentCourse] = JSON.parse(JSON.stringify(state.courseData[state.currentCourse]));
        localStorage.setItem('parkGolf_history_v5_5', JSON.stringify(history)); saveState();
        if(isManual) alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function nextCourseAction() { saveCurrentGame(false); showScreen('game-setup'); }

    function renderHistory() {
        const history = JSON.parse(localStorage.getItem('parkGolf_history_v5_5')) || [];
        const container = document.getElementById('history-container'); container.innerHTML = '<h3>ëˆ„ì  ê¸°ë¡ ë¦¬í¬íŠ¸</h3>';
        if(history.length === 0) container.innerHTML += '<p style="text-align:center; padding:30px; opacity:0.5;">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        history.forEach((day, dIdx) => {
            let combinedData = []; Object.values(day.courses).forEach(c => { combinedData = combinedData.concat(c); });
            const stats = getSummary(combinedData, day.penalty, day.selected);
            
            let dayTotalP = 0;
            day.selected.forEach(idx => { dayTotalP += stats[idx].pCount; });

            const div = document.createElement('div'); div.className = 'card'; div.style = "border-left: 8px solid var(--primary);";
            // [ìˆ˜ì •] ë‚ ì§œ ë’¤ì— (ì´ ?íšŒ) ì¶”ê°€
            div.innerHTML = `<div style="display:flex; justify-content:space-between;"><strong>ğŸ“… ${day.date} (ì´ ${dayTotalP}íšŒ)</strong><button onclick="deleteHistory(${dIdx})" style="color:var(--danger); border:none; background:none; font-weight:bold;">ì‚­ì œ</button></div>`;
            
            day.selected.forEach(idx => { 
                const s = stats[idx]; 
                // [ìˆ˜ì •] "ë²Œê¸ˆ ?íšŒ 000ì›" í˜•ì‹ìœ¼ë¡œ ë³€ê²½
                div.innerHTML += `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px; padding-top:10px; border-top:1px solid #eee;">
                    <div>${day.players[idx]}<br><small>ğŸ†${s.win} ğŸ¤${s.draw} ğŸ’€${s.fail}</small></div>
                    <div class="penalty-highlight" style="min-width:110px; padding:5px;">
                        <span style="font-size:14px; font-weight:900;">ë²Œê¸ˆ ${s.pCount}íšŒ</span>
                        <span style="font-size:15px; font-weight:900;">${(s.pCount * day.penalty).toLocaleString()}ì›</span>
                    </div>
                </div>`; 
            });
            container.appendChild(div);
        });
        attachFeedback();
    }

    function deleteHistory(idx) { if(confirm("ì‚­ì œí• ê¹Œìš”?")) { let history = JSON.parse(localStorage.getItem('parkGolf_history_v5_5')); history.splice(idx, 1); localStorage.setItem('parkGolf_history_v5_5', JSON.stringify(history)); renderHistory(); } }
    function exitApp() { if(confirm("ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { saveState(); saveCurrentGame(false); document.getElementById('app-header').classList.add('hidden'); document.getElementById('app-body').classList.add('hidden'); document.getElementById('exit-overlay').classList.remove('hidden'); } }
    function restartApp() { document.getElementById('exit-overlay').classList.add('hidden'); document.getElementById('app-header').classList.remove('hidden'); document.getElementById('app-body').classList.remove('hidden'); init(); }
</script>
</body>
</html>
